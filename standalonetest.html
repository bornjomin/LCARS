<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Google Sheet Updater</title>
  <style>
    nav a {
      margin: 10px;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
    }
    #status {
      margin-top: 20px;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <nav>
    <a onclick="changeValue('increase')" disabled>+1</a>
    <a onclick="changeValue('decrease')" disabled>-1</a>
  </nav>

  <div id="status">Initializing...</div>

  <div style="margin-top: 20px;">
    <a href="status.html">Courage: <span id="sheetValue">Loading...</span></a><br>
    <a href="Renown.html">Renown: <span id="renownValue">Loading...</span></a><br>
    <a href="wounds.html">Wounds: <span id="woundsValue">Loading...</span></a><br>
    <a href="experience.html">Experience: <span id="experienceValue">Loading...</span></a><br>
    <a href="status.html">Return</a>
  </div>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API client -->
  <script src="https://apis.google.com/js/api.js" async defer onload="onGapiLoad()"></script>

  <script>
    const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com'; // ✅ Replace with your actual client ID
    const API_KEY = 'YOUR_API_KEY'; // ✅ Replace with your actual API key
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
    const SHEET_ID = '1cq8a8QDSOBE4B0JpwqGLRHkL3PiNGNcGxnNHdvFAryU';
    const RANGE = 'Sheet1!B2';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let domReady = false;

    function onGapiLoad() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    window.onload = () => {
      domReady = true;
      maybeEnableButtons();

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // Will be defined during request
      });

      gisInited = true;
      maybeEnableButtons();

      tokenClient.requestAccessToken({
        prompt: '',
        callback: () => {
          loadSheetData();
        }
      });
    };

    function maybeEnableButtons() {
      if (gapiInited && gisInited && domReady) {
        const statusEl = document.getElementById("status");
        if (statusEl) {
          statusEl.textContent = "Ready!";
        }
        document.querySelectorAll('nav a').forEach(btn => btn.removeAttribute('disabled'));
      }
    }

    function changeValue(action) {
      if (gapi.client.getToken()) {
        runUpdate(action);
      } else {
        tokenClient.callback = (resp) => {
          if (resp.error) {
            document.getElementById("status").textContent = "Authentication failed.";
            return;
          }
          runUpdate(action);
        };
        tokenClient.requestAccessToken({ prompt: '' });
      }
    }

    async function runUpdate(action) {
      try {
        const getResp = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SHEET_ID,
          range: RANGE,
        });

        const currentValue = parseInt(getResp.result.values?.[0]?.[0] ?? '1', 10);
        let newValue = currentValue;

        if (action === 'increase') {
          newValue = Math.min(currentValue + 1, 3);
        } else if (action === 'decrease') {
          newValue = Math.max(currentValue - 1, 1);
        }

        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SHEET_ID,
          range: RANGE,
          valueInputOption: 'USER_ENTERED',
          resource: { values: [[newValue]] },
        });

        document.getElementById("status").textContent = `Cell B2 updated to ${newValue}`;
        loadSheetData(); // Refresh values after update
      } catch (err) {
        console.error("Error updating sheet:", err);
        document.getElementById("status").textContent = "Failed to update.";
      }
    }

    async function loadSheetData() {
      if (!domReady) {
        setTimeout(loadSheetData, 100);
        return;
      }

      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SHEET_ID,
          range: 'Sheet1!A2:B6'
        });

        const rows = response.result.values;
        console.log("Fetched rows:", rows);

        const valueMap = {};
        rows.forEach(row => {
          const key = row[0]; // e.g. "Courage"
          const val = row[1]; // e.g. 2
          if (key && val !== undefined) valueMap[key] = val;
        });

        document.getElementById("sheetValue").innerText = valueMap["Courage"] ?? '—';
        document.getElementById("renownValue").innerText = valueMap["Renown"] ?? '—';
        document.getElementById("woundsValue").innerText = valueMap["Wounds"] ?? '—';
        document.getElementById("experienceValue").innerText = valueMap["Experience"] ?? '—';
        document.getElementById("aggressionValue").innerText = valueMap["Aggression"] ?? '—';

      } catch (error) {
        console.error("Error fetching sheet data:", error);
        document.getElementById("sheetValue").innerText = "Error";
        document.getElementById("renownValue").innerText = "Error";
        document.getElementById("woundsValue").innerText = "Error";
        document.getElementById("experienceValue").innerText = "Error";
        document.getElementById("aggressionValue").innerText = "Error";
      }
    }
  </script>
</body>
</html>
